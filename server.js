import express from 'express';
import cors from 'cors';

const app = express();
const PORT = process.env.PORT || 10000;

app.use(cors());
app.use(express.json());
app.use(express.static('public'));

// ะฃะะะซะ AI ะก ะะะะขะะะกะขะะ ะ ะะะะฏะขะฌะฎ
const sessions = new Map(); // {sessionId: {messages: [], leadCollected: false}}

// ะะะะ ะะะะะะ ALLORA (ะฒัััะพะตะฝะฝะฐั ะฒ ะบะพะด)
const alloraKnowledge = {
  company: {
    name: "Allora",
    description: "ะะพะฝัะฐะปัะธะฝะณะพะฒะฐั ะบะพะผะฟะฐะฝะธั, ัะฟะตัะธะฐะปะธะทะธััััะฐััั ะฝะฐ ะฟัะพัะตััะธะพะฝะฐะปัะฝัั ััะปัะณะฐั ะดะปั ะฑะธะทะฝะตัะฐ.",
    services: [
      "ะกััะฐัะตะณะธัะตัะบะธะน ะบะพะฝัะฐะปัะธะฝะณ",
      "ะะฟะตัะฐัะธะพะฝะฝัะน ะบะพะฝัะฐะปัะธะฝะณ", 
      "ะคะธะฝะฐะฝัะพะฒัะน ะบะพะฝัะฐะปัะธะฝะณ",
      "HR-ะบะพะฝัะฐะปัะธะฝะณ",
      "ะขะตัะฝะพะปะพะณะธัะตัะบะธะน ะบะพะฝัะฐะปัะธะฝะณ"
    ],
    contacts: {
      email: "consulting@allora.ai",
      phone: "+7 (495) XXX-XX-XX",
      website: "https://allora-consulting.ai"
    },
    process: [
      "ะะตัะฟะปะฐัะฝะฐั ะบะพะฝััะปััะฐัะธั (30-60 ะผะธะฝ)",
      "ะะฝะฐะปะธะท ัะธััะฐัะธะธ",
      "ะะตัะฐะปัะฝะพะต ะฟัะตะดะปะพะถะตะฝะธะต",
      "ะะพะณะพะฒะพั ะธ ัะตะฐะปะธะทะฐัะธั"
    ]
  }
};

// ะฃะะะซะ AI โ ะะขะะะงะะะข ะะะ ะะะกะขะะฏะฉะะ ะะ
function getAIResponse(userMessage, session) {
  const lower = userMessage.toLowerCase().trim();
  
  // 1. ะะะะะะกะซ ะะะ ALLORA โ ะขะะงะะซะ ะะขะะะขะซ ะะ ะะะะซ ะะะะะะ
  if (lower.includes('allora') || lower.includes('ะฐะปะปะพัะฐ') || lower.includes('ะฒะฐัะฐ ะบะพะผะฟะฐะฝะธั')) {
    if (lower.includes('ััะปัะณ') || lower.includes('ัะตะผ ะทะฐะฝะธะผะฐะตัะตัั')) {
      return `๐ข **Allora ะฟัะตะดะพััะฐะฒะปัะตั ัะปะตะดัััะธะต ััะปัะณะธ:**\n\n` +
             alloraKnowledge.company.services.map(s => `โข ${s}`).join('\n') +
             `\n\nะั ะฟะพะผะพะณะฐะตะผ ะฑะธะทะฝะตัั ัะฐััะธ, ะพะฟัะธะผะธะทะธัะพะฒะฐัั ะฟัะพัะตััั ะธ ะฟะพะฒััะฐัั ัััะตะบัะธะฒะฝะพััั.`;
    }
    
    if (lower.includes('ะบะพะฝัะฐะบั') || lower.includes('ัะฒัะทะฐัััั') || lower.includes('ัะตะปะตัะพะฝ')) {
      return `๐ **ะะพะฝัะฐะบัั Allora:**\n\n` +
             `โข Email: ${alloraKnowledge.company.contacts.email}\n` +
             `โข ะขะตะปะตัะพะฝ: ${alloraKnowledge.company.contacts.phone}\n` +
             `โข ะกะฐะนั: ${alloraKnowledge.company.contacts.website}\n\n` +
             `ะะปั ะฑััััะพะณะพ ะพัะฒะตัะฐ โ ะพััะฐะฒััะต ะทะฐัะฒะบั ะฟััะผะพ ะฒ ัะฐัะต!`;
    }
    
    if (lower.includes('ะฟัะพัะตัั') || lower.includes('ะบะฐะบ ัะฐะฑะพัะฐะตัะต') || lower.includes('ะฝะฐัะฐัั')) {
      return `๐ **ะัะพัะตัั ัะฐะฑะพัั ั Allora:**\n\n` +
             alloraKnowledge.company.process.map((p, i) => `${i+1}. ${p}`).join('\n') +
             `\n\nะฅะพัะธัะต ะฝะฐัะฐัั? ะััะฐะฒััะต ะทะฐัะฒะบั โ ะพะฑััะดะธะผ ะฒะฐัั ะทะฐะดะฐัั.`;
    }
    
    return `๐ข **${alloraKnowledge.company.name}** โ ${alloraKnowledge.company.description}\n\n` +
           `ะฅะพัะธัะต ัะทะฝะฐัั ะฟะพะดัะพะฑะฝะตะต ะพะฑ ััะปัะณะฐั, ะฟัะพัะตััะต ัะฐะฑะพัั ะธะปะธ ะฟะพะปััะธัั ัะฐัััั ััะพะธะผะพััะธ?`;
  }
  
  // 2. ะะะะะะกะซ ะะะ ะกะขะะะะะกะขะฌ โ ะะะะะะะะะะ ะะะฏะะะฃ
  if (lower.includes('ัะบะพะปัะบะพ ััะพะธั') || lower.includes('ัะตะฝะฐ') || lower.includes('ััะพะธะผะพััั') || 
      lower.includes('ะฟัะฐะนั') || lower.includes('ะฑัะดะถะตั') || lower.includes('ัะฐัะธั') ||
      lower.includes('ะฟะฐะบะตั ััะปัะณ') || lower.includes('ัะฐัััั')) {
    
    return `๐ฐ **ะกัะพะธะผะพััั ะบะพะฝัะฐะปัะธะฝะณะพะฒัั ััะปัะณ Allora**\n\n` +
           `ะะฐัััั ะฟัะพะธะทะฒะพะดะธััั ะธะฝะดะธะฒะธะดัะฐะปัะฝะพ ะฟะพัะปะต ะฐะฝะฐะปะธะทะฐ ะฒะฐัะตะน ะทะฐะดะฐัะธ.\n\n` +
           `**ะัะธะผะตัะฝัะต ะดะธะฐะฟะฐะทะพะฝั:**\n` +
           `โข ะกััะฐัะตะณะธัะตัะบะธะน ะบะพะฝัะฐะปัะธะฝะณ: ะพั 500 000 ััะฑ.\n` +
           `โข ะะฟะตัะฐัะธะพะฝะฝัะน ะบะพะฝัะฐะปัะธะฝะณ: ะพั 300 000 ััะฑ./ะผะตั\n` +
           `โข ะคะธะฝะฐะฝัะพะฒัะน ะบะพะฝัะฐะปัะธะฝะณ: ะพั 250 000 ััะฑ.\n\n` +
           `๐ฏ **ะะปั ัะพัะฝะพะณะพ ัะฐััััะฐ** โ ะพััะฐะฒััะต ะทะฐัะฒะบั, ัะฟะตัะธะฐะปะธัั ัะฒัะถะตััั ั ะฒะฐะผะธ ะฒ ัะตัะตะฝะธะต 2 ัะฐัะพะฒ.`;
  }
  
  // 3. ะฃะะะะะะกะะะฌะะซะ AI โ ะะขะะะงะะะข ะะ ะะฎะะซะ ะะะะะะกะซ
  // ะััะพัะธั, ะฝะฐัะบะฐ, ะบัะปััััะฐ, ะฑััะพะฒัะต ะฒะพะฟัะพัั
  if (lower.includes('ะฟััะบะธะฝ')) {
    return `**ะะปะตะบัะฐะฝะดั ะกะตัะณะตะตะฒะธั ะััะบะธะฝ** (1799-1837) โ ะฒะตะปะธะบะธะน ััััะบะธะน ะฟะพัั, ะดัะฐะผะฐัััะณ ะธ ะฟัะพะทะฐะธะบ, ะพัะฝะพะฒะฐัะตะปั ัะพะฒัะตะผะตะฝะฝะพะณะพ ััััะบะพะณะพ ะปะธัะตัะฐัััะฝะพะณะพ ัะทัะบะฐ.\n\n` +
           `**ะัะฝะพะฒะฝัะต ะฟัะพะธะทะฒะตะดะตะฝะธั:** "ะะฒะณะตะฝะธะน ะะฝะตะณะธะฝ", "ะะฐะฟะธัะฐะฝัะบะฐั ะดะพัะบะฐ", "ะะพะฒะตััะธ ะะตะปะบะธะฝะฐ", "ะะพัะธั ะะพะดัะฝะพะฒ".\n\n` +
           `*ะััะฐัะธ, Allora ะบะพะฝััะปััะธััะตั ะฟะพ ะฒะพะฟัะพัะฐะผ ะบะพัะฟะพัะฐัะธะฒะฝะพะน ะบัะปััััั ะธ ะบะพะผะผัะฝะธะบะฐัะธะน โ ะฒะฐะถะฝัั ะฐัะฟะตะบัะพะฒ, ะบะฐะบ ะธ ะฒ ะปะธัะตัะฐัััะต!*`;
  }
  
  if (lower.includes('ัััะป')) {
    return `**ะกััะป** โ ััะพ ะฟัะตะดะผะตั ะผะตะฑะตะปะธ ะดะปั ัะธะดะตะฝะธั ะพะดะฝะพะณะพ ัะตะปะพะฒะตะบะฐ, ัะพ ัะฟะธะฝะบะพะน (ะธะฝะพะณะดะฐ ั ะฟะพะดะปะพะบะพัะฝะธะบะฐะผะธ).\n\n` +
           `**ะะฝัะตัะตัะฝัะน ัะฐะบั:** ะญัะณะพะฝะพะผะธัะฝัะต ัะฐะฑะพัะธะต ะบัะตัะปะฐ ะฟะพะฒััะฐัั ะฟัะพะดัะบัะธะฒะฝะพััั ัะพัััะดะฝะธะบะพะฒ ะฝะฐ 15-20%.\n\n` +
           `*Allora ะฟะพะผะพะณะฐะตั ะพะฟัะธะผะธะทะธัะพะฒะฐัั ัะฐะฑะพัะธะต ะฟัะพัััะฐะฝััะฒะฐ ะดะปั ะฟะพะฒััะตะฝะธั ัััะตะบัะธะฒะฝะพััะธ ะฑะธะทะฝะตัะฐ.*`;
  }
  
  if (lower.includes('ะฝะฐะปะพะณ') || lower.includes('ะดะตะบะปะฐัะฐัะธั')) {
    return `**ะะฐะปะพะณะพะฒะฐั ะดะตะบะปะฐัะฐัะธั** โ ะพัะธัะธะฐะปัะฝัะน ะดะพะบัะผะตะฝั, ะฒ ะบะพัะพัะพะผ ะฝะฐะปะพะณะพะฟะปะฐัะตะปััะธะบ ัะพะพะฑัะฐะตั ะฒ ะฝะฐะปะพะณะพะฒัะต ะพัะณะฐะฝั ะพ ัะฒะพะธั ะดะพัะพะดะฐั ะธ ัะฐััะพะดะฐั.\n\n` +
           `**ะ ะะพััะธะธ** ะพัะฝะพะฒะฝัะผะธ ัะฒะปััััั ะะะคะ (ะดะปั ัะธะทะธัะตัะบะธั ะปะธั) ะธ ะฝะฐะปะพะณ ะฝะฐ ะฟัะธะฑัะปั (ะดะปั ะพัะณะฐะฝะธะทะฐัะธะน).\n\n` +
           `*Allora ะฟัะตะดะพััะฐะฒะปัะตั ะบะพะฝัะฐะปัะธะฝะณ ะฟะพ ะฝะฐะปะพะณะพะฒะพะผั ะฟะปะฐะฝะธัะพะฒะฐะฝะธั ะธ ะพะฟัะธะผะธะทะฐัะธะธ ัะธะฝะฐะฝัะพะฒัั ะฟะพัะพะบะพะฒ.*`;
  }
  
  if (lower.includes('ัะตะผะพะฝั') || lower.includes('ะบะฒะฐััะธั')) {
    return `**ะะตะผะพะฝั ะบะฒะฐััะธัั** ะพะฑััะฝะพ ะฒะบะปััะฐะตั: ะดะตะผะพะฝัะฐะถ, ัะปะตะบััะธะบั, ัะฐะฝัะตัะฝะธะบั, ัััะถะบั ะฟะพะปะฐ, ัััะบะฐัััะบั, ะฟะพะบัะฐัะบั, ัะบะปะฐะดะบั ะฝะฐะฟะพะปัะฝัั ะฟะพะบัััะธะน, ัััะฐะฝะพะฒะบั ัะฐะฝัะตัะฝะธะบะธ ะธ ะผะตะฑะตะปะธ.\n\n` +
           `**ะกัะตะดะฝะธะต ััะพะบะธ:** ะบะพัะผะตัะธัะตัะบะธะน ัะตะผะพะฝั โ 2-4 ะฝะตะดะตะปะธ, ะบะฐะฟะธัะฐะปัะฝัะน โ 2-4 ะผะตัััะฐ.\n\n` +
           `*Allora ะบะพะฝััะปััะธััะตั ะฟะพ ัะฟัะฐะฒะปะตะฝะธั ัััะพะธัะตะปัะฝัะผะธ ะฟัะพะตะบัะฐะผะธ ะธ ะพะฟัะธะผะธะทะฐัะธะธ ะฑะธะทะฝะตั-ะฟัะพัะตััะพะฒ.*`;
  }
  
  if (lower.includes('ะฟะพะณะพะดะฐ')) {
    const weatherResponses = [
      "ะกะตะณะพะดะฝั ะพัะปะธัะฝะฐั ะฟะพะณะพะดะฐ ะดะปั ะฝะพะฒัั ะฑะธะทะฝะตั-ะธะดะตะน! โ๏ธ",
      "ะะพะณะพะดะฐ ะฟะตัะตะผะตะฝัะธะฒะฐ โ ะบะฐะบ ะธ ััะฝะพะบ. ะะฐะถะฝะพ ะฑััั ะณะพัะพะฒัะผ ะบะพ ะฒัะตะผั! โ๏ธ",
      "ะัะตะบัะฐัะฝัะน ะดะตะฝั ะดะปั ะฟะปะฐะฝะธัะพะฒะฐะฝะธั ะธ ัััะฐัะตะณะธัะตัะบะธั ัะตัะตะฝะธะน! ๐ค๏ธ",
      "ะะพะณะพะดะฐ ะฝะฐะฟะพะผะธะฝะฐะตั: ะฒ ะฑะธะทะฝะตัะต ะฒะฐะถะฝะพ ะฟัะตะดะฒะธะดะตัั ะธะทะผะตะฝะตะฝะธั. ๐ฆ๏ธ"
    ];
    const randomWeather = weatherResponses[Math.floor(Math.random() * weatherResponses.length)];
    return `${randomWeather}\n\n*ะััะฐัะธ, Allora ะฟะพะผะพะณะฐะตั ะฑะธะทะฝะตัั ะฐะดะฐะฟัะธัะพะฒะฐัััั ะบ ะธะทะผะตะฝะตะฝะธัะผ ััะฝะบะฐ!*`;
  }
  
  if (lower.includes('ะธะธ') || lower.includes('ะธัะบััััะฒะตะฝะฝัะน ะธะฝัะตะปะปะตะบั') || lower.includes('ai')) {
    return `**ะัะบััััะฒะตะฝะฝัะน ะธะฝัะตะปะปะตะบั (ะะ)** โ ะพะฑะปะฐััั ะบะพะผะฟัััะตัะฝัั ะฝะฐัะบ, ะทะฐะฝะธะผะฐััะฐััั ัะพะทะดะฐะฝะธะตะผ ะผะฐัะธะฝ, ัะฟะพัะพะฑะฝัั ะฒัะฟะพะปะฝััั ะทะฐะดะฐัะธ, ััะตะฑัััะธะต ัะตะปะพะฒะตัะตัะบะพะณะพ ะธะฝัะตะปะปะตะบัะฐ.\n\n` +
           `**ะัะฝะพะฒะฝัะต ะฝะฐะฟัะฐะฒะปะตะฝะธั:** ะผะฐัะธะฝะฝะพะต ะพะฑััะตะฝะธะต, ะฝะตะนัะพัะตัะธ, ะบะพะผะฟัััะตัะฝะพะต ะทัะตะฝะธะต, ะพะฑัะฐะฑะพัะบะฐ ะตััะตััะฒะตะฝะฝะพะณะพ ัะทัะบะฐ.\n\n` +
           `*Allora ะบะพะฝััะปััะธััะตั ะฟะพ ะฒะฝะตะดัะตะฝะธั AI-ัะตัะตะฝะธะน ะฒ ะฑะธะทะฝะตั-ะฟัะพัะตััั ะดะปั ะฟะพะฒััะตะฝะธั ัััะตะบัะธะฒะฝะพััะธ.*`;
  }
  
  if (lower.includes('ะผะฐัะบะตัะธะฝะณ')) {
    return `**ะะฐัะบะตัะธะฝะณ** โ ััะพ ะดะตััะตะปัะฝะพััั ะฟะพ ะฟัะพะดะฒะธะถะตะฝะธั ัะพะฒะฐัะพะฒ ะธ ััะปัะณ ะพั ะฟัะพะธะทะฒะพะดะธัะตะปั ะบ ะฟะพััะตะฑะธัะตะปั.\n\n` +
           `**ะัะฝะพะฒะฝัะต ะธะฝััััะผะตะฝัั:** ะธััะปะตะดะพะฒะฐะฝะธะต ััะฝะบะฐ, ะฟะพะทะธัะธะพะฝะธัะพะฒะฐะฝะธะต, ัะตะฝะพะพะฑัะฐะทะพะฒะฐะฝะธะต, ะฟัะพะดะฒะธะถะตะฝะธะต (ัะตะบะปะฐะผะฐ, PR, digital).\n\n` +
           `*Allora ะฟัะตะดะพััะฐะฒะปัะตั ะบะพะฝัะฐะปัะธะฝะณ ะฟะพ ะผะฐัะบะตัะธะฝะณะพะฒัะผ ัััะฐัะตะณะธัะผ ะธ ัะฒะตะปะธัะตะฝะธั ะฟัะพะดะฐะถ.*`;
  }
  
  if (lower.includes('ะฑััะณะฐะปัะตัะธั') || lower.includes('ัััั')) {
    return `**ะััะณะฐะปัะตััะบะธะน ัััั** โ ัะธััะตะผะฐ ัะฑะพัะฐ, ัะตะณะธัััะฐัะธะธ ะธ ะพะฑะพะฑัะตะฝะธั ะธะฝัะพัะผะฐัะธะธ ะพะฑ ะฐะบัะธะฒะฐั, ะพะฑัะทะฐัะตะปัััะฒะฐั ะธ ะบะฐะฟะธัะฐะปะต ะพัะณะฐะฝะธะทะฐัะธะธ.\n\n` +
           `**ะัะฝะพะฒะฝัะต ะฟัะธะฝัะธะฟั:** ะดะฒะพะนะฝะฐั ะทะฐะฟะธัั, ะดะพะบัะผะตะฝัะธัะพะฒะฐะฝะธะต, ะดะตะฝะตะถะฝะพะต ะธะทะผะตัะตะฝะธะต, ะฟะตัะธะพะดะธัะฝะพััั ะพััััะฝะพััะธ.\n\n` +
           `*Allora ะฟะพะผะพะณะฐะตั ะพะฟัะธะผะธะทะธัะพะฒะฐัั ัะธะฝะฐะฝัะพะฒัะต ะฟัะพัะตััั ะธ ะฑััะณะฐะปัะตััะบะธะน ัััั ะฒ ะบะพะผะฟะฐะฝะธัั.*`;
  }
  
  // 4. ะะะะะะขะกะขะะะฏ
  if (lower.includes('ะฟัะธะฒะตั') || lower.includes('ะทะดัะฐะฒััะฒ') || lower.includes('ะดะพะฑััะน') || lower.includes('hello') || lower.includes('hi')) {
    const greetings = [
      "๐ ะะดัะฐะฒััะฒัะนัะต! ะฏ AI-ะฟะพะผะพัะฝะธะบ Allora. ะะฐะด ะพะฑัะตะฝะธั!",
      "๐ ะัะธะฒะตั! ะฏ ะฒะธัััะฐะปัะฝัะน ะบะพะฝััะปััะฐะฝั Allora. ะงะตะผ ะผะพะณั ะฟะพะผะพัั?",
      "๐ ะะพะฑััะน ะดะตะฝั! ะฏ AI Allora. ะะฐะดะฐะฒะฐะนัะต ะปัะฑัะต ะฒะพะฟัะพัั โ ะพัะฒะตัั ะฝะฐ ะฒัั!",
      "๐ ะัะธะฒะตัััะฒัั! ะฏ ัะผะฝัะน ะฟะพะผะพัะฝะธะบ ะบะพะผะฟะฐะฝะธะธ Allora. ะงัะพ ะฒะฐั ะธะฝัะตัะตััะตั?"
    ];
    return greetings[Math.floor(Math.random() * greetings.length)];
  }
  
  // 5. ะะขะ ะขะซ
  if (lower.includes('ัั ะบัะพ') || lower.includes('ะบัะพ ัั') || lower.includes('ัะฒะพั ะธะผั')) {
    return `๐ค **ะฏ โ AI-ะฟะพะผะพัะฝะธะบ ะบะพะผะฟะฐะฝะธะธ Allora**\n\n` +
           `ะฏ ะผะพะณั:\n` +
           `โข ะัะฒะตัะฐัั ะฝะฐ ะปัะฑัะต ะฒะพะฟัะพัั (ะธััะพัะธั, ะฝะฐัะบะฐ, ะฑะธะทะฝะตั, ะบัะปััััะฐ)\n` +
           `โข ะะฐััะบะฐะทะฐัั ะพะฑ ััะปัะณะฐั Allora\n` +
           `โข ะะพะผะพัั ั ะพัะพัะผะปะตะฝะธะตะผ ะทะฐัะฒะบะธ ะฝะฐ ะบะพะฝััะปััะฐัะธั\n\n` +
           `ะกะฟัะฐัะธะฒะฐะนัะต ััะพ ัะณะพะดะฝะพ โ ั ะทะดะตัั, ััะพะฑั ะฟะพะผะพัั!`;
  }
  
  // 6. ะะะ ะะะะ / ะงะขะ ะะะะะะ
  if (lower.includes('ะบะฐะบ ะดะตะปะฐ') || lower.includes('ะบะฐะบ ะถะธะทะฝั') || lower.includes('ััะพ ะฝะพะฒะพะณะพ')) {
    const statuses = [
      "ะัะปะธัะฝะพ! ะะพัะพะฒ ะฟะพะผะพะณะฐัั ั ะฒะฐัะธะผะธ ะฒะพะฟัะพัะฐะผะธ. ะ ั ะฒะฐั ะบะฐะบ ะดะตะปะฐ?",
      "ะัั ะฟัะตะบัะฐัะฝะพ! ะะทััะฐั ะฝะพะฒัะต ัะตะผั, ััะพะฑั ะปัััะต ะพัะฒะตัะฐัั ะฝะฐ ะฒะพะฟัะพัั. ะงัะพ ั ะฒะฐั ะฝะพะฒะพะณะพ?",
      "ะะฐะผะตัะฐัะตะปัะฝะพ! ะกะตะณะพะดะฝั ัะถะต ะฟะพะผะพะณ ะฝะตัะบะพะปัะบะธะผ ะบะปะธะตะฝัะฐะผ. ะงะตะผ ะผะพะณั ะฟะพะผะพัั ะฒะฐะผ?",
      "ะัั ัะพัะพัะพ, ัะฟะฐัะธะฑะพ! ะะพัะพะฒ ะบ ะฝะพะฒัะผ ะธะฝัะตัะตัะฝัะผ ะฒะพะฟัะพัะฐะผ. ะงัะพ ะฒะฐั ะธะฝัะตัะตััะตั?"
    ];
    return statuses[Math.floor(Math.random() * statuses.length)];
  }
  
  // 7. ะะกะะ ะะ ะะะะะะะะข ะะะะะะก โ ะฃะะะซะ ะะขะะะข
  const dontUnderstandResponses = [
    `๐ค **ะะฝัะตัะตัะฝัะน ะฒะพะฟัะพั:** "${userMessage}"\n\nะฏ AI-ะฟะพะผะพัะฝะธะบ Allora. ะะพะณั ะพัะฒะตัะธัั ะฝะฐ ะฒะพะฟัะพัั ะฟะพ ะธััะพัะธะธ, ะฝะฐัะบะต, ะฑะธะทะฝะตัั, ะธะปะธ ัะฐััะบะฐะทะฐัั ะพ ะบะพะฝัะฐะปัะธะฝะณะพะฒัั ััะปัะณะฐั ะฝะฐัะตะน ะบะพะผะฟะฐะฝะธะธ. ะงัะพ ะธะผะตะฝะฝะพ ะฒะฐั ะธะฝัะตัะตััะตั?`,
    `๐ง **ะั ัะฟัะฐัะธะฒะฐะตัะต:** "${userMessage}"\n\nะญัะพ ะธะฝัะตัะตัะฝะฐั ัะตะผะฐ! ะะฐะบ AI-ะฟะพะผะพัะฝะธะบ Allora, ั ะผะพะณั ะพะฑััะดะธัั ั ะฒะฐะผะธ ัะฐะทะปะธัะฝัะต ะฒะพะฟัะพัั ะธะปะธ ัะฐััะบะฐะทะฐัั ะพ ะฝะฐัะธั ะฟัะพัะตััะธะพะฝะฐะปัะฝัั ััะปัะณะฐั.`,
    `๐ญ **ะะพ ะฒะฐัะตะผั ะฒะพะฟัะพัั:** "${userMessage}"\n\nะฏ ะบะพะฝััะปััะธััั ะฟะพ ัะธัะพะบะพะผั ะบััะณั ัะตะผ. ะะพะถะตัะต ััะพัะฝะธัั ะฒะพะฟัะพั ะธะปะธ ัะฟัะพัะธัั ะพ ััะผ-ัะพ ะบะพะฝะบัะตัะฝะพะผ? ะขะฐะบะถะต ะผะพะณั ัะฐััะบะฐะทะฐัั ะพะฑ ััะปัะณะฐั Allora.`
  ];
  
  return dontUnderstandResponses[Math.floor(Math.random() * dontUnderstandResponses.length)];
}

// API ะญะะะะะะะขะซ
app.get('/test', (req, res) => {
  res.json({
    status: 'OK',
    message: 'ะฃะผะฝัะน AI Allora ัะฐะฑะพัะฐะตั!',
    version: 'v7.0 โ ะะะกะขะะฏะฉะะ ะฃะะะซะ AI',
    mode: 'ะฃะฝะธะฒะตััะฐะปัะฝัะน AI + ัะฑะพั ะปะธะดะพะฒ ะฟะพัะปะต 2 ัะพะพะฑัะตะฝะธะน',
    sessions: sessions.size,
    features: ['ะฃะผะฝัะต ะพัะฒะตัั ะฝะฐ ะฒัั', 'ะะฐะผััั ะบะพะฝัะตะบััะฐ', 'ะะฐะทะฐ ะทะฝะฐะฝะธะน Allora', 'ะัะณะบะธะน ัะฑะพั ะปะธะดะพะฒ']
  });
});

app.get('/health', (req, res) => {
  res.send('OK');
});

// ะะะะะะซะ AI ะงะะข
app.post('/api/chat', (req, res) => {
  try {
    const { message, sessionId = 'ai_' + Date.now() } = req.body;
    
    // ะะะะฆะะะะะะะฆะะฏ ะกะะกะกะะ ะก ะะะะฏะขะฌะฎ
    if (!sessions.has(sessionId)) {
      sessions.set(sessionId, {
        messages: [],
        leadCollected: false,
        createdAt: new Date()
      });
    }
    
    const session = sessions.get(sessionId);
    
    // ะะะะะะะฏะะ ะกะะะะฉะะะะ ะะะะฌะะะะะขะะะฏ ะ ะะกะขะะะะฎ
    session.messages.push({
      role: 'user',
      content: message,
      timestamp: new Date()
    });
    
    // ะะะะะะ: ะะะกะะ 2-ะะ ะกะะะะฉะะะะฏ โ ะะะะะะะะะะ ะะะะะะะกะขะะ
    let requiresLeadForm = false;
    
    if (!session.leadCollected && session.messages.filter(m => m.role === 'user').length >= 2) {
      requiresLeadForm = true;
    }
    
    // ะะะะะะก ะะะ ะฆะะะฃ โ ะกะะะะฃ ะะะะะะะะะะ ะะะฏะะะฃ
    const lowerMessage = message.toLowerCase();
    const isPriceRequest = lowerMessage.includes('ัะบะพะปัะบะพ ััะพะธั') || 
                          lowerMessage.includes('ัะตะฝะฐ') || 
                          lowerMessage.includes('ััะพะธะผะพััั') ||
                          lowerMessage.includes('ะฟัะฐะนั') ||
                          lowerMessage.includes('ะฑัะดะถะตั') ||
                          lowerMessage.includes('ะฟะฐะบะตั ััะปัะณ');
    
    if (isPriceRequest && !session.leadCollected) {
      requiresLeadForm = true;
    }
    
    // ะะะะฃะงะะะ ะฃะะะซะ ะะขะะะข ะะข AI
    const aiReply = getAIResponse(message, session);
    
    // ะะะะะะะฏะะ ะะขะะะข AI ะ ะะกะขะะะะฎ
    session.messages.push({
      role: 'assistant',
      content: aiReply,
      timestamp: new Date()
    });
    
    // ะคะะะะะะฃะะ ะคะะะะะฌะะซะ ะะขะะะข
    let finalReply = aiReply;
    
    if (requiresLeadForm && !session.leadCollected) {
      finalReply = `${finalReply}\n\n---\n\n**๐ฏ ะะ, ะะะะะะขะ ะะะะะะะะะะะกะฏ ะะะะะะะ, ะงะขะะะซ ะะะะะะะะะขะฌ ะะะจะฃ ะะะกะะะฃ!**\n\n` +
                   `ะััะฐะฒััะต ะบะพะฝัะฐะบัั โ ะธ ะผั ัะผะพะถะตะผ ะพะฑัะฐัััั ะดะฐะปััะต ะฑะตะท ะพะณัะฐะฝะธัะตะฝะธะน.`;
    }
    
    // ะะขะะะะะะฏะะ ะะขะะะข
    res.json({
      success: true,
      reply: finalReply,
      requiresLeadForm: requiresLeadForm,
      sessionId: sessionId,
      messageCount: session.messages.filter(m => m.role === 'user').length,
      leadCollected: session.leadCollected,
      isPriceRequest: isPriceRequest,
      debug: {
        sessionMessages: session.messages.length,
        userMessages: session.messages.filter(m => m.role === 'user').length
      }
    });
    
  } catch (error) {
    console.error('AI ะพัะธะฑะบะฐ:', error);
    res.status(500).json({
      success: false,
      reply: 'ะัะพะธะทะพัะปะฐ ะพัะธะฑะบะฐ ะฒ AI. ะะพะถะฐะปัะนััะฐ, ะฟะพะฟัะพะฑัะนัะต ะทะฐะดะฐัั ะฒะพะฟัะพั ะตัั ัะฐะท.',
      requiresLeadForm: false
    });
  }
});

// ะกะะฅะะะะะะะ ะะะะขะะะขะะ ะ ะะะะะฅะะ ะ "ะะะงะะซะ ะะะะะ"
app.post('/api/lead', (req, res) => {
  try {
    const { name, email, phone, sessionId } = req.body;
    
    console.log('โ ะะพะฝัะฐะบัั ะฟะพะปััะตะฝั:', { name, email: email ? 'ะตััั' : 'ะฝะตั', phone: phone ? 'ะตััั' : 'ะฝะตั' });
    
    // ะะะะะะะะะ ะกะะกะกะะฎ ะ "ะะะงะะซะ ะะะะะ"
    if (sessionId && sessions.has(sessionId)) {
      sessions.get(sessionId).leadCollected = true;
      console.log(`๐ ะกะตััะธั ${sessionId.substring(0, 8)} ะฟะตัะตะฒะตะดะตะฝะฐ ะฒ ะฒะตัะฝัะน ัะตะถะธะผ`);
    }
    
    res.json({
      success: true,
      message: '๐ **ะัะปะธัะฝะพ! ะกะฟะฐัะธะฑะพ ะทะฐ ะทะฝะฐะบะพะผััะฒะพ!**\n\nะขะตะฟะตัั ั ะผะพะณั ะฟะพะผะพะณะฐัั ะฒะฐะผ ะฑะตะท ะพะณัะฐะฝะธัะตะฝะธะน. ะะฐะดะฐะฒะฐะนัะต ะปัะฑัะต ะฒะพะฟัะพัั โ ะพัะฒะตัั ะฝะฐ ะฒัั!',
      authorized: true,
      mode: 'unlimited_ai'
    });
    
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'ะัะธะฑะบะฐ ัะพััะฐะฝะตะฝะธั. ะะพะถะฐะปัะนััะฐ, ะฟะพะฟัะพะฑัะนัะต ะตัั ัะฐะท.'
    });
  }
});

app.post('/api/auth', (req, res) => {
  try {
    const { name, email, phone, sessionId } = req.body;
    
    if (sessionId && sessions.has(sessionId)) {
      sessions.get(sessionId).leadCollected = true;
    }
    
    res.json({
      success: true,
      message: '๐ **ะัะปะธัะฝะพ! ะกะฟะฐัะธะฑะพ ะทะฐ ะทะฝะฐะบะพะผััะฒะพ!**\n\nะขะตะฟะตัั ั ะผะพะณั ะฟะพะผะพะณะฐัั ะฒะฐะผ ะฑะตะท ะพะณัะฐะฝะธัะตะฝะธะน. ะะฐะดะฐะฒะฐะนัะต ะปัะฑัะต ะฒะพะฟัะพัั โ ะพัะฒะตัั ะฝะฐ ะฒัั!',
      authorized: true
    });
    
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'ะัะธะฑะบะฐ ะฐะฒัะพัะธะทะฐัะธะธ. ะะพะฟัะพะฑัะนัะต ะตัั ัะฐะท.'
    });
  }
});

// ะะะะฃะกะ
app.listen(PORT, () => {
  console.log('๐ ============================================');
  console.log('๐ง ALLORA AI v7.0 โ ะะะกะขะะฏะฉะะ ะฃะะะซะ AI');
  console.log('๐ ะะพัั:', PORT);
  console.log('๐ฏ ะะตะถะธะผ: ะฃะฝะธะฒะตััะฐะปัะฝัะน AI + ัะฑะพั ะปะธะดะพะฒ');
  console.log('๐ ะะฝะฐะตั: ะััะบะธะฝ, ัััะป, ะฝะฐะปะพะณะธ, ะะ, ะผะฐัะบะตัะธะฝะณ, ะฑััะณะฐะปัะตัะธั');
  console.log('๐ข ะะฐะทะฐ ะทะฝะฐะฝะธะน: ะะพะปะฝะฐั ะธะฝัะพัะผะฐัะธั ะพ Allora');
  console.log('๐ ะะพะณะธะบะฐ: 2 ัะพะพะฑัะตะฝะธั โ ะทะฝะฐะบะพะผััะฒะพ');
  console.log('๐ผ ะฆะตะฝะฐ โ ััะฐะทั ะทะฐัะฒะบะฐ');
  console.log('๐ ============================================');
});
